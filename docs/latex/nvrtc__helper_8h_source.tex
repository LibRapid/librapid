\hypertarget{nvrtc__helper_8h_source}{}\doxysection{nvrtc\+\_\+helper.\+h}
\label{nvrtc__helper_8h_source}\index{librapid/include/librapid/cuda/nvrtc\_helper.h@{librapid/include/librapid/cuda/nvrtc\_helper.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/* Copyright (c) 2019, NVIDIA CORPORATION. All rights reserved.}}
\DoxyCodeLine{2 \textcolor{comment}{ *}}
\DoxyCodeLine{3 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}}
\DoxyCodeLine{4 \textcolor{comment}{ * modification, are permitted provided that the following conditions}}
\DoxyCodeLine{5 \textcolor{comment}{ * are met:}}
\DoxyCodeLine{6 \textcolor{comment}{ *  * Redistributions of source code must retain the above copyright}}
\DoxyCodeLine{7 \textcolor{comment}{ *    notice, this list of conditions and the following disclaimer.}}
\DoxyCodeLine{8 \textcolor{comment}{ *  * Redistributions in binary form must reproduce the above copyright}}
\DoxyCodeLine{9 \textcolor{comment}{ *    notice, this list of conditions and the following disclaimer in the}}
\DoxyCodeLine{10 \textcolor{comment}{ *    documentation and/or other materials provided with the distribution.}}
\DoxyCodeLine{11 \textcolor{comment}{ *  * Neither the name of NVIDIA CORPORATION nor the names of its}}
\DoxyCodeLine{12 \textcolor{comment}{ *    contributors may be used to endorse or promote products derived}}
\DoxyCodeLine{13 \textcolor{comment}{ *    from this software without specific prior written permission.}}
\DoxyCodeLine{14 \textcolor{comment}{ *}}
\DoxyCodeLine{15 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY}}
\DoxyCodeLine{16 \textcolor{comment}{ * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}}
\DoxyCodeLine{17 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR}}
\DoxyCodeLine{18 \textcolor{comment}{ * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR}}
\DoxyCodeLine{19 \textcolor{comment}{ * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,}}
\DoxyCodeLine{20 \textcolor{comment}{ * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,}}
\DoxyCodeLine{21 \textcolor{comment}{ * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR}}
\DoxyCodeLine{22 \textcolor{comment}{ * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY}}
\DoxyCodeLine{23 \textcolor{comment}{ * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT}}
\DoxyCodeLine{24 \textcolor{comment}{ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE}}
\DoxyCodeLine{25 \textcolor{comment}{ * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.}}
\DoxyCodeLine{26 \textcolor{comment}{ */}}
\DoxyCodeLine{27 }
\DoxyCodeLine{28 \textcolor{preprocessor}{\#ifndef COMMON\_NVRTC\_HELPER\_H\_}}
\DoxyCodeLine{29 }
\DoxyCodeLine{30 \textcolor{preprocessor}{\#define COMMON\_NVRTC\_HELPER\_H\_ 1}}
\DoxyCodeLine{31 }
\DoxyCodeLine{32 \textcolor{preprocessor}{\#include <cuda.h>}}
\DoxyCodeLine{33 \textcolor{preprocessor}{\#include <fstream>}}
\DoxyCodeLine{34 \textcolor{preprocessor}{\#include "{}helper\_cuda\_drvapi.h"{}}}
\DoxyCodeLine{35 \textcolor{preprocessor}{\#include <iostream>}}
\DoxyCodeLine{36 \textcolor{preprocessor}{\#include <nvrtc.h>}}
\DoxyCodeLine{37 \textcolor{preprocessor}{\#include <sstream>}}
\DoxyCodeLine{38 \textcolor{preprocessor}{\#include <string>}}
\DoxyCodeLine{39 }
\DoxyCodeLine{40 \textcolor{preprocessor}{\#define NVRTC\_SAFE\_CALL(Name, x)                                                                   \(\backslash\)}}
\DoxyCodeLine{41 \textcolor{preprocessor}{    do \{                                                                                           \(\backslash\)}}
\DoxyCodeLine{42 \textcolor{preprocessor}{        nvrtcResult result = x;                                                                    \(\backslash\)}}
\DoxyCodeLine{43 \textcolor{preprocessor}{        if (result != NVRTC\_SUCCESS) \{                                                             \(\backslash\)}}
\DoxyCodeLine{44 \textcolor{preprocessor}{            std::cerr << "{}\(\backslash\)nerror: "{}} << Name << "{} failed with error "{}                              \(\backslash\)}
\DoxyCodeLine{45                       << nvrtcGetErrorString(result);                                              \(\backslash\)}
\DoxyCodeLine{46             exit(1);                                                                               \(\backslash\)}
\DoxyCodeLine{47         \}                                                                                          \(\backslash\)}
\DoxyCodeLine{48     \} while (0)}
\DoxyCodeLine{49 }
\DoxyCodeLine{50 \textcolor{keywordtype}{void} compileFileToCUBIN(\textcolor{keywordtype}{char} *filename, \textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} **argv, \textcolor{keywordtype}{char} **cubinResult,}
\DoxyCodeLine{51                         \textcolor{keywordtype}{size\_t} *cubinResultSize, \textcolor{keywordtype}{int} requiresCGheaders) \{}
\DoxyCodeLine{52     std::ifstream inputFile(filename, std::ios::in | std::ios::binary | std::ios::ate);}
\DoxyCodeLine{53 }
\DoxyCodeLine{54     \textcolor{keywordflow}{if} (!inputFile.is\_open()) \{}
\DoxyCodeLine{55         std::cerr << \textcolor{stringliteral}{"{}\(\backslash\)nerror: unable to open "{}} << filename << \textcolor{stringliteral}{"{} for reading!\(\backslash\)n"{}};}
\DoxyCodeLine{56         exit(1);}
\DoxyCodeLine{57     \}}
\DoxyCodeLine{58 }
\DoxyCodeLine{59     std::streampos pos = inputFile.tellg();}
\DoxyCodeLine{60     \textcolor{keywordtype}{size\_t} inputSize   = (size\_t)pos;}
\DoxyCodeLine{61     \textcolor{keywordtype}{char} *memBlock     = \textcolor{keyword}{new} \textcolor{keywordtype}{char}[inputSize + 1];}
\DoxyCodeLine{62 }
\DoxyCodeLine{63     inputFile.seekg(0, std::ios::beg);}
\DoxyCodeLine{64     inputFile.read(memBlock, inputSize);}
\DoxyCodeLine{65     inputFile.close();}
\DoxyCodeLine{66     memBlock[inputSize] = \textcolor{stringliteral}{'\(\backslash\)x0'};}
\DoxyCodeLine{67 }
\DoxyCodeLine{68     \textcolor{keywordtype}{int} numCompileOptions = 0;}
\DoxyCodeLine{69 }
\DoxyCodeLine{70     \textcolor{keywordtype}{char} *compileParams[2];}
\DoxyCodeLine{71 }
\DoxyCodeLine{72     \textcolor{keywordtype}{int} major = 0, minor = 0;}
\DoxyCodeLine{73     \textcolor{keywordtype}{char} deviceName[256];}
\DoxyCodeLine{74 }
\DoxyCodeLine{75     \textcolor{comment}{// Picks the best CUDA device available}}
\DoxyCodeLine{76     CUdevice cuDevice = findCudaDeviceDRV(argc, (\textcolor{keyword}{const} \textcolor{keywordtype}{char} **)argv);}
\DoxyCodeLine{77 }
\DoxyCodeLine{78     \textcolor{comment}{// get compute capabilities and the devicename}}
\DoxyCodeLine{79     checkCudaErrors(}
\DoxyCodeLine{80       cuDeviceGetAttribute(\&major, CU\_DEVICE\_ATTRIBUTE\_COMPUTE\_CAPABILITY\_MAJOR, cuDevice));}
\DoxyCodeLine{81     checkCudaErrors(}
\DoxyCodeLine{82       cuDeviceGetAttribute(\&minor, CU\_DEVICE\_ATTRIBUTE\_COMPUTE\_CAPABILITY\_MINOR, cuDevice));}
\DoxyCodeLine{83 }
\DoxyCodeLine{84     \{}
\DoxyCodeLine{85         \textcolor{comment}{// Compile cubin for the GPU arch on which are going to run cuda kernel.}}
\DoxyCodeLine{86         std::string compileOptions;}
\DoxyCodeLine{87         compileOptions = \textcolor{stringliteral}{"{}-\/-\/gpu-\/architecture=sm\_"{}};}
\DoxyCodeLine{88 }
\DoxyCodeLine{89         compileParams[numCompileOptions] =}
\DoxyCodeLine{90           \textcolor{keyword}{reinterpret\_cast<}\textcolor{keywordtype}{char} *\textcolor{keyword}{>}(malloc(\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}) * (compileOptions.length() + 10)));}
\DoxyCodeLine{91 \textcolor{preprocessor}{\#if defined(WIN32) || defined(\_WIN32) || defined(WIN64) || defined(\_WIN64)}}
\DoxyCodeLine{92         sprintf\_s(compileParams[numCompileOptions],}
\DoxyCodeLine{93                   \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}) * (compileOptions.length() + 10),}
\DoxyCodeLine{94                   \textcolor{stringliteral}{"{}\%s\%d\%d"{}},}
\DoxyCodeLine{95                   compileOptions.c\_str(),}
\DoxyCodeLine{96                   major,}
\DoxyCodeLine{97                   minor);}
\DoxyCodeLine{98 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{99         snprintf(compileParams[numCompileOptions],}
\DoxyCodeLine{100                  compileOptions.size() + 10,}
\DoxyCodeLine{101                  \textcolor{stringliteral}{"{}\%s\%d\%d"{}},}
\DoxyCodeLine{102                  compileOptions.c\_str(),}
\DoxyCodeLine{103                  major,}
\DoxyCodeLine{104                  minor);}
\DoxyCodeLine{105 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{106     \}}
\DoxyCodeLine{107 }
\DoxyCodeLine{108     numCompileOptions++;}
\DoxyCodeLine{109 }
\DoxyCodeLine{110     \textcolor{keywordflow}{if} (requiresCGheaders) \{}
\DoxyCodeLine{111         std::string compileOptions;}
\DoxyCodeLine{112         \textcolor{keywordtype}{char} HeaderNames[256];}
\DoxyCodeLine{113 \textcolor{preprocessor}{\#if defined(WIN32) || defined(\_WIN32) || defined(WIN64) || defined(\_WIN64)}}
\DoxyCodeLine{114         sprintf\_s(HeaderNames, \textcolor{keyword}{sizeof}(HeaderNames), \textcolor{stringliteral}{"{}\%s"{}}, \textcolor{stringliteral}{"{}cooperative\_groups.h"{}});}
\DoxyCodeLine{115 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{116         snprintf(HeaderNames, \textcolor{keyword}{sizeof}(HeaderNames), \textcolor{stringliteral}{"{}\%s"{}}, \textcolor{stringliteral}{"{}cooperative\_groups.h"{}});}
\DoxyCodeLine{117 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{118 }
\DoxyCodeLine{119         compileOptions = \textcolor{stringliteral}{"{}-\/-\/include-\/path="{}};}
\DoxyCodeLine{120 }
\DoxyCodeLine{121         std::string path = sdkFindFilePath(HeaderNames, argv[0]);}
\DoxyCodeLine{122         \textcolor{keywordflow}{if} (!path.empty()) \{}
\DoxyCodeLine{123             std::size\_t found = path.find(HeaderNames);}
\DoxyCodeLine{124             path.erase(found);}
\DoxyCodeLine{125         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{126             printf(}
\DoxyCodeLine{127               \textcolor{stringliteral}{"{}\(\backslash\)nCooperativeGroups headers not found, please install it in \%s "{}}}
\DoxyCodeLine{128               \textcolor{stringliteral}{"{}sample directory..\(\backslash\)n Exiting..\(\backslash\)n"{}},}
\DoxyCodeLine{129               argv[0]);}
\DoxyCodeLine{130         \}}
\DoxyCodeLine{131         compileOptions += path.c\_str();}
\DoxyCodeLine{132         compileParams[numCompileOptions] =}
\DoxyCodeLine{133           \textcolor{keyword}{reinterpret\_cast<}\textcolor{keywordtype}{char} *\textcolor{keyword}{>}(malloc(\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}) * (compileOptions.length() + 1)));}
\DoxyCodeLine{134 \textcolor{preprocessor}{\#if defined(WIN32) || defined(\_WIN32) || defined(WIN64) || defined(\_WIN64)}}
\DoxyCodeLine{135         sprintf\_s(compileParams[numCompileOptions],}
\DoxyCodeLine{136                   \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}) * (compileOptions.length() + 1),}
\DoxyCodeLine{137                   \textcolor{stringliteral}{"{}\%s"{}},}
\DoxyCodeLine{138                   compileOptions.c\_str());}
\DoxyCodeLine{139 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{140         snprintf(}
\DoxyCodeLine{141           compileParams[numCompileOptions], compileOptions.size(), \textcolor{stringliteral}{"{}\%s"{}}, compileOptions.c\_str());}
\DoxyCodeLine{142 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{143         numCompileOptions++;}
\DoxyCodeLine{144     \}}
\DoxyCodeLine{145 }
\DoxyCodeLine{146     \textcolor{comment}{// compile}}
\DoxyCodeLine{147     nvrtcProgram prog;}
\DoxyCodeLine{148     NVRTC\_SAFE\_CALL(\textcolor{stringliteral}{"{}nvrtcCreateProgram"{}},}
\DoxyCodeLine{149                     nvrtcCreateProgram(\&prog, memBlock, filename, 0, NULL, NULL));}
\DoxyCodeLine{150 }
\DoxyCodeLine{151     nvrtcResult res = nvrtcCompileProgram(prog, numCompileOptions, compileParams);}
\DoxyCodeLine{152 }
\DoxyCodeLine{153     \textcolor{comment}{// dump log}}
\DoxyCodeLine{154     \textcolor{keywordtype}{size\_t} logSize;}
\DoxyCodeLine{155     NVRTC\_SAFE\_CALL(\textcolor{stringliteral}{"{}nvrtcGetProgramLogSize"{}}, nvrtcGetProgramLogSize(prog, \&logSize));}
\DoxyCodeLine{156     \textcolor{keywordtype}{char} *log = \textcolor{keyword}{reinterpret\_cast<}\textcolor{keywordtype}{char} *\textcolor{keyword}{>}(malloc(\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}) * logSize + 1));}
\DoxyCodeLine{157     NVRTC\_SAFE\_CALL(\textcolor{stringliteral}{"{}nvrtcGetProgramLog"{}}, nvrtcGetProgramLog(prog, log));}
\DoxyCodeLine{158     log[logSize] = \textcolor{stringliteral}{'\(\backslash\)x0'};}
\DoxyCodeLine{159 }
\DoxyCodeLine{160     \textcolor{keywordflow}{if} (strlen(log) >= 2) \{}
\DoxyCodeLine{161         std::cerr << \textcolor{stringliteral}{"{}\(\backslash\)n compilation log -\/-\/-\/\(\backslash\)n"{}};}
\DoxyCodeLine{162         std::cerr << log;}
\DoxyCodeLine{163         std::cerr << \textcolor{stringliteral}{"{}\(\backslash\)n end log -\/-\/-\/\(\backslash\)n"{}};}
\DoxyCodeLine{164     \}}
\DoxyCodeLine{165 }
\DoxyCodeLine{166     free(log);}
\DoxyCodeLine{167 }
\DoxyCodeLine{168     NVRTC\_SAFE\_CALL(\textcolor{stringliteral}{"{}nvrtcCompileProgram"{}}, res);}
\DoxyCodeLine{169 }
\DoxyCodeLine{170     \textcolor{keywordtype}{size\_t} codeSize;}
\DoxyCodeLine{171     NVRTC\_SAFE\_CALL(\textcolor{stringliteral}{"{}nvrtcGetCUBINSize"{}}, nvrtcGetCUBINSize(prog, \&codeSize));}
\DoxyCodeLine{172     \textcolor{keywordtype}{char} *code = \textcolor{keyword}{new} \textcolor{keywordtype}{char}[codeSize];}
\DoxyCodeLine{173     NVRTC\_SAFE\_CALL(\textcolor{stringliteral}{"{}nvrtcGetCUBIN"{}}, nvrtcGetCUBIN(prog, code));}
\DoxyCodeLine{174     *cubinResult     = code;}
\DoxyCodeLine{175     *cubinResultSize = codeSize;}
\DoxyCodeLine{176 }
\DoxyCodeLine{177     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < numCompileOptions; i++) \{ free(compileParams[i]); \}}
\DoxyCodeLine{178 \}}
\DoxyCodeLine{179 }
\DoxyCodeLine{180 CUmodule loadCUBIN(\textcolor{keywordtype}{char} *cubin, \textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} **argv) \{}
\DoxyCodeLine{181     CUmodule module;}
\DoxyCodeLine{182     CUcontext context;}
\DoxyCodeLine{183     \textcolor{keywordtype}{int} major = 0, minor = 0;}
\DoxyCodeLine{184     \textcolor{keywordtype}{char} deviceName[256];}
\DoxyCodeLine{185 }
\DoxyCodeLine{186     \textcolor{comment}{// Picks the best CUDA device available}}
\DoxyCodeLine{187     CUdevice cuDevice = findCudaDeviceDRV(argc, (\textcolor{keyword}{const} \textcolor{keywordtype}{char} **)argv);}
\DoxyCodeLine{188 }
\DoxyCodeLine{189     \textcolor{comment}{// get compute capabilities and the devicename}}
\DoxyCodeLine{190     checkCudaErrors(}
\DoxyCodeLine{191       cuDeviceGetAttribute(\&major, CU\_DEVICE\_ATTRIBUTE\_COMPUTE\_CAPABILITY\_MAJOR, cuDevice));}
\DoxyCodeLine{192     checkCudaErrors(}
\DoxyCodeLine{193       cuDeviceGetAttribute(\&minor, CU\_DEVICE\_ATTRIBUTE\_COMPUTE\_CAPABILITY\_MINOR, cuDevice));}
\DoxyCodeLine{194     checkCudaErrors(cuDeviceGetName(deviceName, 256, cuDevice));}
\DoxyCodeLine{195     printf(\textcolor{stringliteral}{"{}> GPU Device has SM \%d.\%d compute capability\(\backslash\)n"{}}, major, minor);}
\DoxyCodeLine{196 }
\DoxyCodeLine{197     checkCudaErrors(cuInit(0));}
\DoxyCodeLine{198     checkCudaErrors(cuCtxCreate(\&context, 0, cuDevice));}
\DoxyCodeLine{199 }
\DoxyCodeLine{200     checkCudaErrors(cuModuleLoadData(\&module, cubin));}
\DoxyCodeLine{201     free(cubin);}
\DoxyCodeLine{202 }
\DoxyCodeLine{203     \textcolor{keywordflow}{return} module;}
\DoxyCodeLine{204 \}}
\DoxyCodeLine{205 }
\DoxyCodeLine{206 \textcolor{preprocessor}{\#endif }\textcolor{comment}{// COMMON\_NVRTC\_HELPER\_H\_}}

\end{DoxyCode}
