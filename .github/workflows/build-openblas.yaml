name: Build OpenBLAS

on:
  schedule:
    - cron: "0 12 1/5 * *"
  workflow_dispatch:

jobs:
  openblas_unix:
    name: Build OpenBLAS on ${{ matrix.platform }}
    runs-on: ${{ matrix.platform }}

    strategy:
      fail-fast: false
      matrix:
        platform: [ macos-latest, ubuntu-latest ]
        targetplatform: [ x64 ]

    steps:
      - name: Extract branch name
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract_branch

      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          submodules: recursive
          ref: ${{ steps.extract_branch.outputs.branch }}

      - name: Set Up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      # - if: runner.os == 'macOS'
      #   name: Set Up GCC
      #   run: |
      #     brew install gcc

      - name: Get latest CMake and ninja
        uses: lukka/get-cmake@latest

      - name: Install Requirements
        run: |
          python -m pip install -r requirements.txt

      # git reset --hard d909f9f3d4fc4ccff36d69f178558df154ba1002
      # 939452ea9dcb57abdcc3f1278c6db668a4690465
      - name: Clone OpenBLAS
        run: |
          git clone https://github.com/xianyi/OpenBLAS.git
          cd OpenBLAS
          git reset --hard 939452ea9dcb57abdcc3f1278c6db668a4690465
        shell: bash

      # Double up the make command. Explained above
      - name: Build OpenBLAS
        run: |
          cd OpenBLAS
          make NUM_THREADS=128 DYNAMIC_ARCH=ON DYNAMIC_LIST='CORE2;NEHALEM;SANDYBRIDGE;BULLDOZER;HASWELL' TARGET=NEHALEM

      - name: Install OpenBLAS
        run: |
          cd OpenBLAS
          make install PREFIX=../src/librapid/openblas_install

      - name: Archive OpenBLAS Build
        uses: actions/upload-artifact@v2
        with:
          name: OpenBLAS on ${{ matrix.platform }}
          path: src/librapid/openblas_install

  openblas_windows:
    name: Build OpenBLAS on Windows
    runs-on: windows-latest

    steps:
      - name: Extract branch name
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract_branch

      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          submodules: recursive
          ref: ${{ steps.extract_branch.outputs.branch }}

      - name: Set Up WSL
        uses: Vampire/setup-wsl@v1.1.1

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          miniconda-version: "latest"

      # - name: Set up conda
      #   uses: s-weigand/setup-conda@v1
      #   with:
      #     update-conda: true
      #     python-version: ${{ matrix.python-version }}
      #     conda-channels: anaconda, conda-forge

      - name: Set Up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Set Up Visual Studio shell
        uses: egor-tensin/vs-shell@v2

      - name: Install Requirements
        run: |
          python -m pip install -r requirements.txt

      # conda install --yes -c conda-forge mpmath
      # conda install --yes openmp
      - name: Install Conda things
        run: |
          C:/Miniconda/condabin/conda.bat env update --file environment.yml --name base
          C:/Miniconda/condabin/conda.bat init powershell

          conda update conda --yes
          conda update --all --yes
          conda config --add channels conda-forge --force
          conda config --set auto_update_conda true
          conda install clangdev cmake ninja flang --yes
          conda install flang --yes

          ls C:/Miniconda
          ls C:/Miniconda/Library
          ls C:/Miniconda/Library/bin

      # git reset --hard d909f9f3d4fc4ccff36d69f178558df154ba1002
      # 939452ea9dcb57abdcc3f1278c6db668a4690465
      - name: Clone OpenBLAS
        run: |
          git clone https://github.com/xianyi/OpenBLAS.git
          cd OpenBLAS
          git reset --hard 939452ea9dcb57abdcc3f1278c6db668a4690465
        shell: bash

      - name: Configure CMake
        run: |
          cd OpenBLAS

          set "LIB=%CONDA_PREFIX%\Library\lib;%LIB%"
          set "CPATH=%CONDA_PREFIX%\Library\include;%CPATH%"
          mkdir build
          cd build

          cmake .. -G "Ninja" -DCMAKE_CXX_COMPILER=clang-cl -DCMAKE_C_COMPILER=clang-cl -DCMAKE_Fortran_COMPILER=flang -DCMAKE_MT=mt -DBUILD_SHARED_LIBS=ON -DBUILD_WITHOUT_LAPACK=no -DNOFORTRAN=0 -DNUM_THREADS=128 -DDYNAMIC_ARCH=ON -DDYNAMIC_LIST='CORE2;NEHALEM;SANDYBRIDGE;BULLDOZER;HASWELL' -DTARGET=NEHALEM -DCMAKE_BUILD_TYPE=Release
        shell: pwsh

      - name: Build OpenBLAS
        run: |
          cd OpenBLAS
          cd build
          cmake --build . --config Release
        shell: pwsh

      - name: Install OpenBLAS
        run: |
          cd OpenBLAS
          cd build
          cmake --install . --prefix ../../src/librapid/openblas_install

      # - name: Copy required DLLs
      #   run: |
      #     copy C:/Miniconda/Library/bin/flang.dll src/librapid/openblas_install
      #     copy C:/Miniconda/Library/bin/flangrti.dll src/librapid/openblas_install
      #     copy C:/Miniconda/Library/bin/pgmath.dll src/librapid/openblas_install
      #     copy C:/Miniconda/Library/bin/libomp.dll src/librapid/openblas_install

      - name: List Root Directories and files
        run: |
          dir
          dir src
          dir src/librapid
          dir src/librapid/openblas_install
          dir src/librapid/openblas_install/bin

      - name: Archive OpenBLAS Build
        uses: actions/upload-artifact@v2
        with:
          name: OpenBLAS on windows-latest
          path: src/librapid/openblas_install
